---
import { SITE_TITLE } from '../consts';
import HeaderLink from './HeaderLink.astro';
import { Github, Twitter, Menu, X, Terminal, Search } from 'lucide-react';
---

<header class="bg-zinc-950/90 backdrop-blur-sm border-b border-zinc-800 sticky top-0 z-50">
	<nav class="max-w-4xl mx-auto px-4 py-3">
		<div class="flex items-center justify-between">
			<h2 class="text-xl font-bold tracking-tight flex items-center gap-2 relative z-50">
				<Terminal className="w-6 h-6 text-blue-500" />
				<a href="/" class="text-zinc-100 hover:text-blue-400 transition-colors no-underline font-mono">
					{SITE_TITLE}
				</a>
			</h2>
			
			<!-- Mobile Menu Button -->
			<button id="mobile-menu-btn" class="md:hidden text-zinc-400 hover:text-blue-400 focus:outline-none relative z-50 p-2" aria-label="Toggle menu">
				<div class="relative w-6 h-6">
                    <Menu className="w-6 h-6 absolute top-0 left-0 transition-all duration-300" id="menu-icon-open" />
                    <X className="w-6 h-6 absolute top-0 left-0 transition-all duration-300 opacity-0 rotate-90 scale-0" id="menu-icon-close" />
                </div>
			</button>

			<div class="hidden md:flex gap-6 items-center">
				<HeaderLink href="/" aria-label="Home">~/home</HeaderLink>
				<HeaderLink href="/blog" aria-label="Blog">~/blog</HeaderLink>
				<HeaderLink href="/about" aria-label="About">~/about</HeaderLink>
			</div>

			<div class="hidden md:flex gap-4 items-center border-l border-zinc-800 pl-4">
				<a href="https://x.com/ZeroLiv3sLeft" target="_blank" class="text-zinc-400 hover:text-blue-400 transition-colors" aria-label="Follow on X/Twitter">
					<Twitter size={20} />
				</a>
				<a href="https://bsky.app/profile/zer0.live" target="_blank" class="text-zinc-400 hover:text-blue-400 transition-colors" aria-label="Follow on Bluesky">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 600 530" fill="currentColor">
						<path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
					</svg>
				</a>
				<a href="https://github.com/zerolivesleft" target="_blank" class="text-zinc-400 hover:text-blue-400 transition-colors" aria-label="GitHub profile">
					<Github size={20} />
				</a>
				
			<!-- Global Search Button -->
			<button 
				id="global-search-trigger" 
				class="flex items-center justify-between gap-2.5 px-3.5 py-2.5 rounded-lg bg-zinc-900/80 border border-zinc-800 hover:border-blue-500/50 hover:bg-zinc-900 transition-all group ml-4 shadow-sm hover:shadow-blue-500/10 min-w-[140px] xl:min-w-[180px]"
				aria-label="Search all posts"
				title="Search posts (Ctrl+Shift+K)"
			>
				<div class="flex items-center gap-2.5">
					<span class="text-zinc-500 group-hover:text-zinc-300 text-sm font-medium">grep</span>
					<span class="text-xs text-zinc-600 group-hover:text-zinc-500 transition-colors hidden lg:inline">all posts</span>
				</div>
				<kbd class="inline-flex items-center gap-0.5 px-2 py-1 bg-zinc-800 border border-zinc-700 rounded text-sm font-mono text-zinc-200 group-hover:text-white group-hover:border-zinc-600 group-hover:bg-zinc-750 transition-colors font-semibold">
					<span class="text-[13px]">⌘</span><span class="text-[13px]">⇧</span><span class="text-[13px]">K</span>
				</kbd>
			</button>
			</div>
		</div>
	</nav>
</header>

<!-- Mobile Menu Overlay (outside header for proper positioning) -->
<div id="mobile-menu" class="fixed left-0 right-0 bottom-0 top-[var(--header-height)] bg-zinc-950/90 backdrop-blur-sm transform translate-x-full transition-transform duration-300 md:hidden z-40 flex flex-col p-8 overflow-y-auto overscroll-contain">
	<div id="mobile-menu-content" class="flex flex-col gap-6 text-xl font-mono">
		<HeaderLink href="/" class="py-2 border-b border-zinc-800/50" aria-label="Home">~/home</HeaderLink>
		<HeaderLink href="/blog" class="py-2 border-b border-zinc-800/50" aria-label="Blog">~/blog</HeaderLink>
		<HeaderLink href="/about" class="py-2 border-b border-zinc-800/50" aria-label="About">~/about</HeaderLink>
	</div>
	
	<div class="mt-auto pb-8">
		<p class="text-zinc-500 text-sm mb-4">Connect with me:</p>
		<div class="flex gap-6">
			<a href="https://x.com/ZeroLiv3sLeft" target="_blank" class="text-zinc-400 hover:text-blue-400 transition-colors" aria-label="Follow on X/Twitter">
				<Twitter size={24} />
			</a>
			<a href="https://bsky.app/profile/zer0.live" target="_blank" class="text-zinc-400 hover:text-blue-400 transition-colors" aria-label="Follow on Bluesky">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 600 530" fill="currentColor">
					<path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
				</svg>
			</a>
			<a href="https://github.com/zerolivesleft" target="_blank" class="text-zinc-400 hover:text-blue-400 transition-colors" aria-label="GitHub profile">
				<Github size={24} />
			</a>
		</div>
	</div>
</div>

<!-- Global Search Modal -->
<div id="global-search-modal" class="hidden fixed inset-0 bg-zinc-950/0 backdrop-blur-0 z-[60] items-start justify-center pt-32 transition-all duration-300">
	<div class="w-full max-w-2xl mx-4 transform translate-y-4 opacity-0 transition-all duration-300" id="global-search-modal-content">
		<!-- Pagefind Search Container -->
		<div id="pagefind-container" class="bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden shadow-2xl shadow-blue-500/10">
			<!-- Search Header - fixed at top -->
			<div class="flex items-center gap-2 px-4 py-3 border-b border-zinc-800 bg-zinc-900/50" id="search-header">
				<span class="text-blue-500 text-base md:text-sm font-medium flex-shrink-0">grep</span>
				<input type="text" id="global-search-input" class="flex-1 min-w-0 bg-transparent border-none outline-none text-zinc-100 placeholder-zinc-500 text-base md:text-sm font-mono" placeholder="Search all posts..." autocomplete="off" />
				<button id="global-search-clear" class="text-base md:text-xs bg-zinc-800 text-zinc-400 px-2 py-1 rounded hover:bg-zinc-700 hover:text-zinc-300 transition-colors hidden">Clear</button>
				<span class="text-xs text-zinc-600 font-mono flex-shrink-0 ml-2">ESC to close</span>
			</div>
			<!-- Pagefind Results Container -->
			<div id="pagefind-search-wrapper"></div>
		</div>
	</div>
</div>

<style is:global>
	/* Custom scrollbar for search results */
	#pagefind-search-wrapper::-webkit-scrollbar {
		width: 6px;
	}

	#pagefind-search-wrapper::-webkit-scrollbar-track {
		background: transparent;
	}

	#pagefind-search-wrapper::-webkit-scrollbar-thumb {
		background: #3f3f46;
		border-radius: 3px;
	}

	/* Highlight marks in excerpts */
	#pagefind-search-wrapper mark {
		background: rgba(59, 130, 246, 0.25);
		color: #93c5fd;
		border-radius: 2px;
		padding: 0 2px;
	}
</style>

<script is:inline>
	// Set CSS variable for header height
	const updateHeaderHeight = () => {
		const header = document.querySelector('header');
		if (header) {
			const height = header.offsetHeight;
			document.documentElement.style.setProperty('--header-height', `${height}px`);
		}
	};

	updateHeaderHeight();
	window.addEventListener('resize', updateHeaderHeight);

	// Mobile menu toggle
	const menuBtn = document.getElementById('mobile-menu-btn');
	const mobileMenu = document.getElementById('mobile-menu');
    const openIcon = document.getElementById('menu-icon-open');
    const closeIcon = document.getElementById('menu-icon-close');

    const getScrollbarWidth = () => {
        return window.innerWidth - document.documentElement.clientWidth;
    };

	if (menuBtn && mobileMenu && openIcon && closeIcon) {
        let scrollPosition = 0;
        const header = document.querySelector('header');
        
        const toggleMenu = (show) => {
            if (show) {
                // Store scroll position before locking
                scrollPosition = window.scrollY;
                mobileMenu.classList.remove('translate-x-full');
                const scrollbarWidth = getScrollbarWidth();
                // Lock both html and body to prevent iOS scroll
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.top = `-${scrollPosition}px`;
                document.body.style.left = '0';
                document.body.style.right = '0';
                document.body.style.paddingRight = `${scrollbarWidth}px`;
                // Keep header visible by making it fixed at top
                if (header) {
                    header.style.position = 'fixed';
                    header.style.top = '0';
                    header.style.left = '0';
                    header.style.right = '0';
                }
                openIcon.classList.add('opacity-0', 'rotate-90', 'scale-0');
                closeIcon.classList.remove('opacity-0', 'rotate-90', 'scale-0');
            } else {
                mobileMenu.classList.add('translate-x-full');
                openIcon.classList.remove('opacity-0', 'rotate-90', 'scale-0');
                closeIcon.classList.add('opacity-0', 'rotate-90', 'scale-0');
                setTimeout(() => {
                    // Restore scroll position after unlocking
                    document.documentElement.style.overflow = '';
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.left = '';
                    document.body.style.right = '';
                    document.body.style.paddingRight = '';
                    // Restore header to sticky
                    if (header) {
                        header.style.position = '';
                        header.style.top = '';
                        header.style.left = '';
                        header.style.right = '';
                    }
                    window.scrollTo(0, scrollPosition);
                }, 300);
            }
        };

		menuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
			const isOpen = !mobileMenu.classList.contains('translate-x-full');
			toggleMenu(!isOpen);
		});

        mobileMenu.addEventListener('click', (e) => {
            if (e.target === mobileMenu) {
                toggleMenu(false);
            }
        });

        document.addEventListener('click', (e) => {
            const isOpen = !mobileMenu.classList.contains('translate-x-full');
            if (isOpen && !mobileMenu.contains(e.target) && !menuBtn.contains(e.target)) {
                toggleMenu(false);
            }
        });

        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768 && !mobileMenu.classList.contains('translate-x-full')) {
                toggleMenu(false);
            }
        });
	}

	// Global search with Pagefind (using headless API)
	const globalSearchModal = document.getElementById('global-search-modal');
	const globalSearchModalContent = document.getElementById('global-search-modal-content');
	const globalSearchTrigger = document.getElementById('global-search-trigger');
	const pagefindWrapper = document.getElementById('pagefind-search-wrapper');
	const customSearchInput = document.getElementById('global-search-input');
	const customClearBtn = document.getElementById('global-search-clear');

	if (globalSearchModal && globalSearchModalContent && globalSearchTrigger && pagefindWrapper && customSearchInput && customClearBtn) {
		let pagefind = null;
		let selectedIndex = -1;
		let searchTimeout = null;

		const initPagefind = async () => {
			if (pagefind) return;
			try {
				pagefind = await import('/pagefind/pagefind.js');
				await pagefind.init();
			} catch (e) {
				console.error('Failed to load Pagefind:', e);
			}
		};

		const renderResults = (results, query) => {
			if (!results.length) {
				pagefindWrapper.innerHTML = '<div class="p-4 text-center text-zinc-500 text-sm">No results found for "' + query + '"</div>';
				return;
			}

			let html = '<div class="text-xs text-zinc-500 px-4 py-2 border-b border-zinc-800/50">' + results.length + ' result' + (results.length === 1 ? '' : 's') + ' for "' + query + '"</div>';
			html += '<div class="max-h-[50vh] overflow-y-auto">';
			results.forEach((result, i) => {
				html += '<a href="' + result.url + '" class="search-result block px-4 py-3 border-b border-zinc-800/50 last:border-b-0 hover:bg-zinc-800/50 transition-colors border-l-2 border-l-transparent hover:border-l-blue-500" data-index="' + i + '">';
				html += '<div class="font-medium text-zinc-200 mb-1">' + (result.meta && result.meta.title ? result.meta.title : 'Untitled') + '</div>';
				html += '<div class="text-sm text-zinc-500 line-clamp-2">' + (result.excerpt || '') + '</div>';
				html += '</a>';
			});
			html += '</div>';
			pagefindWrapper.innerHTML = html;
		};

		const doSearch = async (query) => {
			if (!pagefind || !query.trim()) {
				pagefindWrapper.innerHTML = '';
				return;
			}

			try {
				const search = await pagefind.search(query);
				const results = await Promise.all(
					search.results.slice(0, 10).map(r => r.data())
				);
				renderResults(results, query);
			} catch (e) {
				console.error('Search error:', e);
				pagefindWrapper.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">Search error</div>';
			}
		};

		// Wire custom input to Pagefind
		customSearchInput.addEventListener('input', (e) => {
			const query = e.target.value;
			selectedIndex = -1;
			
			// Show/hide clear button
			if (query.length > 0) {
				customClearBtn.classList.remove('hidden');
			} else {
				customClearBtn.classList.add('hidden');
				pagefindWrapper.innerHTML = '';
			}
			
			// Debounce search
			if (searchTimeout) clearTimeout(searchTimeout);
			searchTimeout = setTimeout(() => doSearch(query), 150);
		});

		// Clear button
		customClearBtn.addEventListener('click', () => {
			customSearchInput.value = '';
			customClearBtn.classList.add('hidden');
			selectedIndex = -1;
			pagefindWrapper.innerHTML = '';
			customSearchInput.focus();
		});

		// Keyboard navigation
		customSearchInput.addEventListener('keydown', (e) => {
			const results = Array.from(pagefindWrapper.querySelectorAll('.search-result'));
			if (!results.length) return;
			
			if (e.key === 'ArrowDown') {
				e.preventDefault();
				selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
				results.forEach((r, i) => {
					if (i === selectedIndex) {
						r.style.backgroundColor = 'rgba(39, 39, 42, 0.7)';
						r.style.borderLeftColor = '#3b82f6';
						r.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
					} else {
						r.style.backgroundColor = '';
						r.style.borderLeftColor = 'transparent';
					}
				});
			} else if (e.key === 'ArrowUp') {
				e.preventDefault();
				if (selectedIndex > 0) {
					selectedIndex--;
					results.forEach((r, i) => {
						if (i === selectedIndex) {
							r.style.backgroundColor = 'rgba(39, 39, 42, 0.7)';
							r.style.borderLeftColor = '#3b82f6';
							r.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
						} else {
							r.style.backgroundColor = '';
							r.style.borderLeftColor = 'transparent';
						}
					});
				} else {
					selectedIndex = -1;
					results.forEach(r => {
						r.style.backgroundColor = '';
						r.style.borderLeftColor = 'transparent';
					});
				}
			} else if (e.key === 'Enter') {
				e.preventDefault();
				if (selectedIndex >= 0 && results[selectedIndex]) {
					window.location.href = results[selectedIndex].getAttribute('href') || '';
				} else if (results.length > 0) {
					window.location.href = results[0].getAttribute('href') || '';
				}
			}
		});

		const openGlobalSearch = () => {
			globalSearchModal.classList.remove('hidden');
			globalSearchModal.classList.add('flex');
			requestAnimationFrame(() => {
				globalSearchModal.classList.remove('bg-zinc-950/0', 'backdrop-blur-0');
				globalSearchModal.classList.add('bg-zinc-950/95', 'backdrop-blur-xl');
				globalSearchModalContent.classList.remove('translate-y-4', 'opacity-0');
				globalSearchModalContent.classList.add('translate-y-0', 'opacity-100');
			});
			
			// Initialize Pagefind on first open
			initPagefind();
			
			// Focus custom input
			setTimeout(() => {
				customSearchInput.focus();
			}, 100);
		};

		const closeGlobalSearch = () => {
			globalSearchModal.classList.remove('bg-zinc-950/95', 'backdrop-blur-xl');
			globalSearchModal.classList.add('bg-zinc-950/0', 'backdrop-blur-0');
			globalSearchModalContent.classList.remove('translate-y-0', 'opacity-100');
			globalSearchModalContent.classList.add('translate-y-4', 'opacity-0');
			
			setTimeout(() => {
				globalSearchModal.classList.add('hidden');
				globalSearchModal.classList.remove('flex');
				// Clear search
				customSearchInput.value = '';
				customClearBtn.classList.add('hidden');
				selectedIndex = -1;
				pagefindWrapper.innerHTML = '';
			}, 300);
		};

		// Open with button or keyboard
		globalSearchTrigger.addEventListener('click', openGlobalSearch);

		document.addEventListener('keydown', (e) => {
			// Global search: Ctrl+Shift+K (must have shift)
			if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'k') {
				e.preventDefault();
				openGlobalSearch();
			}
			// Close with ESC
			if (e.key === 'Escape' && !globalSearchModal.classList.contains('hidden')) {
				closeGlobalSearch();
			}
		});

		// Close when clicking outside
		globalSearchModal.addEventListener('click', (e) => {
			if (e.target === globalSearchModal) {
				closeGlobalSearch();
			}
		});
	}
</script>

