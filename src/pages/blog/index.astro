---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';
import { Image } from 'astro:assets';

const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`Blog | ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
	</head>
	<body class="bg-zinc-950 text-zinc-100 flex flex-col min-h-screen font-mono">
		<Header />
		<main class="w-full max-w-5xl mx-auto px-4 py-6 md:py-12 flex-grow">
			<section>
				<!-- Page Header -->
				<div class="mb-8 md:mb-12">
					<h1 class="text-2xl md:text-4xl font-bold mb-3 flex items-center gap-3">
						<span class="text-blue-500" aria-hidden="true">~/</span>
						<span>Blog</span>
					</h1>
					<p class="text-zinc-500 text-sm md:text-base">
						{posts.length} articles on development, technology, and learning in public.
					</p>
				</div>

				<!-- Search Bar - Terminal Style -->
				<div class="mb-6 md:mb-8">
					<div class="bg-zinc-900 border border-zinc-800 rounded-lg overflow-hidden focus-within:border-blue-500/50 transition-colors">
						<div class="flex items-center gap-3 px-4 py-3">
							<span class="text-blue-500 text-base md:text-sm font-bold flex-shrink-0" aria-hidden="true">grep</span>
							<input 
								type="text" 
								id="search-input" 
								class="flex-1 bg-transparent border-none outline-none text-zinc-100 placeholder-zinc-500 text-base md:text-sm font-mono"
								placeholder="Search articles..."
								aria-label="Search articles"
								autocomplete="off"
							/>
							<button 
								id="clear-search" 
								class="invisible opacity-0 text-zinc-500 hover:text-zinc-300 transition-all text-base md:text-sm font-mono px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 hover:border-zinc-600"
							>
								Clear
							</button>
							<span class="text-xs text-zinc-600 font-mono hidden md:inline">ESC to clear</span>
						</div>
					</div>
					<!-- Search hint -->
					<div class="mt-2 text-xs text-zinc-600 flex items-center gap-2">
						<span>Searches titles and descriptions</span>
						<span class="hidden md:inline text-zinc-700">•</span>
						<span class="hidden md:inline">Press <kbd class="px-1.5 py-0.5 bg-zinc-800 rounded text-zinc-400">Enter</kbd> on single result to open</span>
					</div>
				</div>

				<!-- Results count -->
				<div class="flex items-center justify-between mb-4 text-sm">
					<span id="results-count" class="text-zinc-500">
						Showing <span class="text-zinc-300">{posts.length}</span> articles
					</span>
					<div id="no-results" class="hidden text-amber-500 flex items-center gap-2">
						<span>No matching articles</span>
					</div>
				</div>

				<!-- Post List -->
				<div class="space-y-4" id="post-container">
					<ul class="space-y-4 relative" id="post-list">
						{
							posts.map((post, index) => (
								<li 
									class="group post-item opacity-100 translate-y-0 transition-all duration-300 ease-out" 
									data-title={post.data.title.toLowerCase()} 
									data-description={post.data.description.toLowerCase()}
									style={`transition-delay: ${index * 50}ms`}
								>
									<a 
										href={`/blog/${post.id}/`} 
										class="block bg-zinc-900/50 border border-zinc-800 rounded-xl overflow-hidden hover:border-blue-500/30 hover:bg-zinc-900 transition-all"
									>
										<div class="flex flex-col md:flex-row">
											<!-- Image -->
											{post.data.heroImage && (
												<div class="md:w-48 lg:w-56 flex-shrink-0">
													<div class="aspect-video md:aspect-[4/3] md:h-full relative overflow-hidden bg-zinc-800">
														<Image 
															src={post.data.heroImage} 
															alt={post.data.title}
															class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
															width={300}
															height={200}
														/>
														<div class="absolute inset-0 bg-gradient-to-t from-zinc-900/50 to-transparent md:bg-gradient-to-r"></div>
													</div>
												</div>
											)}
											
											<!-- Content -->
											<div class="flex-1 p-4 md:p-5 flex flex-col justify-center">
												<div class="flex items-center gap-2 mb-2">
													<time class="text-xs text-zinc-500 font-mono">
														<FormattedDate date={post.data.pubDate} />
													</time>
												</div>
												<h2 class="font-semibold text-zinc-200 group-hover:text-blue-400 transition-colors text-base md:text-lg leading-snug mb-2">
													{post.data.title}
												</h2>
												<p class="text-sm text-zinc-500 line-clamp-2 leading-relaxed">
													{post.data.description}
												</p>
												
												<!-- Read more -->
												<div class="mt-3 flex items-center gap-2 text-xs text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">
													<span>→ Read article</span>
												</div>
											</div>
										</div>
									</a>
								</li>
							))
						}
					</ul>
					
					<!-- Empty state -->
					<div id="empty-state" class="hidden py-16 text-center bg-zinc-900/30 rounded-xl border border-zinc-800">
						<div class="w-16 h-16 mx-auto mb-4 bg-zinc-800 rounded-full flex items-center justify-center">
							<span class="text-2xl text-zinc-600">∅</span>
						</div>
						<p class="text-zinc-400 mb-2">No articles found</p>
						<p class="text-sm text-zinc-600">Try a different search term</p>
					</div>
				</div>

				<!-- Footer hint -->
				<div class="mt-8 text-center text-xs text-zinc-600">
					<span class="hidden md:inline">Start typing anywhere to search</span>
					<span class="md:hidden">Use the search bar above to filter articles</span>
				</div>
			</section>
		</main>
		<Footer />

		<style>
			@keyframes fadeIn {
				from {
					opacity: 0;
					transform: translateY(8px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
			.animate-fade-in {
				animation: fadeIn 0.3s ease-out forwards;
			}
		</style>

        <script>
            const searchInput = document.getElementById('search-input') as HTMLInputElement;
            const clearBtn = document.getElementById('clear-search');
            const postList = document.getElementById('post-list');
            const resultsCount = document.getElementById('results-count');
            const noResults = document.getElementById('no-results');
            const emptyState = document.getElementById('empty-state');
            
            if (searchInput && postList && clearBtn && resultsCount && noResults && emptyState) {
                const posts = Array.from(postList.querySelectorAll('li')) as HTMLElement[];
                const totalPosts = posts.length;

                const filterPosts = (term: string) => {
                    const lowerTerm = term.toLowerCase().trim();
                    let visibleCount = 0;
                    let visibleIndex = 0;
                    
                    posts.forEach((post) => {
                        const title = (post.getAttribute('data-title') || '');
                        const description = (post.getAttribute('data-description') || '');
                        
                        if (!lowerTerm || title.includes(lowerTerm) || description.includes(lowerTerm)) {
                            // Show with animation
                            post.style.transitionDelay = `${visibleIndex * 30}ms`;
                            post.classList.remove('opacity-0', 'translate-y-2', 'scale-95', 'pointer-events-none', 'absolute', '-z-10');
                            post.classList.add('opacity-100', 'translate-y-0', 'scale-100');
                            visibleCount++;
                            visibleIndex++;
                        } else {
                            // Hide with animation
                            post.style.transitionDelay = '0ms';
                            post.classList.add('opacity-0', 'translate-y-2', 'scale-95', 'pointer-events-none', 'absolute', '-z-10');
                            post.classList.remove('opacity-100', 'translate-y-0', 'scale-100');
                        }
                    });

                    // Update UI
                    if (visibleCount === 0 && lowerTerm) {
                        emptyState.classList.remove('hidden');
                        emptyState.classList.add('animate-fade-in');
                        noResults.classList.remove('hidden');
                        resultsCount.classList.add('hidden');
                    } else {
                        emptyState.classList.add('hidden');
                        emptyState.classList.remove('animate-fade-in');
                        noResults.classList.add('hidden');
                        resultsCount.classList.remove('hidden');
                        resultsCount.innerHTML = lowerTerm 
                            ? `Found <span class="text-zinc-300">${visibleCount}</span> of ${totalPosts} articles`
                            : `Showing <span class="text-zinc-300">${totalPosts}</span> articles`;
                    }

                    // Show/hide clear button
                    if (term) {
                        clearBtn.classList.remove('invisible', 'opacity-0');
                    } else {
                        clearBtn.classList.add('invisible', 'opacity-0');
                    }

                    return visibleCount;
                };

                // Search input handler
                searchInput.addEventListener('input', (e) => {
                    filterPosts((e.target as HTMLInputElement).value);
                });

                // Clear button
                clearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    filterPosts('');
                    searchInput.focus();
                });

                // Handle Enter key to open single result
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const visiblePosts = posts.filter(post => !post.classList.contains('opacity-0'));
                        if (visiblePosts.length === 1) {
                            const link = visiblePosts[0].querySelector('a');
                            if (link) {
                                window.location.href = link.href;
                            }
                        }
                    }
                    // Clear on Escape
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        filterPosts('');
                        searchInput.blur();
                    }
                });
                    
                // Focus on keydown if not typing elsewhere (desktop)
                document.addEventListener('keydown', (e) => {
                    if (window.innerWidth >= 768 && 
                        document.activeElement === document.body && 
                        e.key.length === 1 && 
                        !e.ctrlKey && !e.metaKey && !e.altKey) {
                        searchInput.focus();
                    }
                    // Also focus on Ctrl/Cmd + F
                    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                        e.preventDefault();
                        searchInput.focus();
                        searchInput.select();
                    }
                });
            }
        </script>
	</body>
</html>
